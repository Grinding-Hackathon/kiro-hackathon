# Complete Deployment Guide\n\n## 🎯 Overview\n\nThis guide covers the complete deployment process for the Offline Blockchain Wallet system, including backend API, mobile app, and infrastructure setup.\n\n## 📋 Prerequisites\n\n### System Requirements\n- Docker 20.10+\n- Docker Compose 2.0+\n- Node.js 18+\n- PostgreSQL 13+\n- Redis 6+\n- Nginx 1.20+\n- SSL certificates\n- Domain name\n\n### Development Tools\n- Git\n- npm/yarn\n- Xcode 15+ (for iOS)\n- Apple Developer Account\n- Ethereum node access (Infura/Alchemy)\n\n## 🖥️ Backend Deployment\n\n### 1. Environment Setup\n\n```bash\n# Clone repository\ngit clone <repository-url>\ncd backend\n\n# Create production environment\ncp .env.example .env.production\n```\n\n### 2. Production Environment Variables\n\n```bash\n# Server Configuration\nPORT=3000\nNODE_ENV=production\nAPI_VERSION=v1\n\n# Database\nDB_HOST=postgres\nDB_PORT=5432\nDB_NAME=wallet_prod\nDB_USER=wallet_user\nDB_PASSWORD=secure_production_password\nDB_SSL=true\n\n# JWT Security\nJWT_SECRET=your_super_secure_jwt_secret_256_bits\nJWT_EXPIRES_IN=24h\nJWT_REFRESH_EXPIRES_IN=7d\n\n# Blockchain\nETH_RPC_URL=https://mainnet.infura.io/v3/your_infura_key\nETH_PRIVATE_KEY=0x...\nCONTRACT_ADDRESS=0x...\n\n# Redis\nREDIS_URL=redis://redis:6379\nREDIS_PASSWORD=secure_redis_password\n\n# Security\nRATE_LIMIT_WINDOW_MS=900000\nRATE_LIMIT_MAX_REQUESTS=100\nBCRYPT_SALT_ROUNDS=12\n```\n\n### 3. Database Setup\n\n```bash\n# Start PostgreSQL container\ndocker-compose -f infrastructure/docker-compose.prod.yml up -d postgres\n\n# Wait for database to be ready\nsleep 10\n\n# Run migrations\nnpm run db:migrate:prod\n\n# Seed initial data (optional)\nnpm run db:seed:prod\n```\n\n### 4. SSL Certificate Setup\n\n```bash\n# Using Let's Encrypt\n./scripts/setup-ssl.sh your-domain.com\n\n# Or use existing certificates\ncp /path/to/cert.pem infrastructure/ssl/\ncp /path/to/key.pem infrastructure/ssl/\n```\n"#
## 5. Smart Contract Deployment\n\n```bash\n# Deploy to mainnet\nnpm run deploy:mainnet\n\n# Verify contract on Etherscan\nnpm run verify:contract -- --network mainnet\n\n# Update contract address in environment\necho \"CONTRACT_ADDRESS=0x...\" >> .env.production\n```\n\n### 6. Production Deployment\n\n```bash\n# Build and deploy all services\n./scripts/deploy-production.sh\n\n# Verify deployment\ncurl https://your-domain.com/health\n```\n\n## 📱 Mobile App Deployment\n\n### 1. iOS App Store Preparation\n\n```bash\ncd ios/offline-blockchain-wallet-ios\n\n# Update version\n./scripts/update-version.sh 1.0.0\n\n# Configure release settings\nvim offline-blockchain-wallet-ios/Configuration/Release.xcconfig\n```\n\n### 2. Build for Release\n\n```bash\n# Clean and build\n./scripts/build.sh --release\n\n# Run tests\nswift test\n\n# Archive for App Store\nxcodebuild archive -scheme offline-blockchain-wallet-ios \\\n  -archivePath build/offline-blockchain-wallet-ios.xcarchive\n```\n\n### 3. App Store Submission\n\n```bash\n# Export for App Store\nxcodebuild -exportArchive \\\n  -archivePath build/offline-blockchain-wallet-ios.xcarchive \\\n  -exportPath build/AppStore \\\n  -exportOptionsPlist ExportOptions.plist\n\n# Upload to App Store Connect\nxcrun altool --upload-app \\\n  -f build/AppStore/offline-blockchain-wallet-ios.ipa \\\n  -u your-apple-id@example.com\n```\n\n## 🏗️ Infrastructure Setup\n\n### Docker Compose Configuration\n\n```yaml\n# docker-compose.prod.yml\nversion: '3.8'\nservices:\n  app:\n    build: .\n    ports:\n      - \"3000:3000\"\n    environment:\n      - NODE_ENV=production\n    depends_on:\n      - postgres\n      - redis\n    restart: unless-stopped\n\n  postgres:\n    image: postgres:13\n    environment:\n      POSTGRES_DB: wallet_prod\n      POSTGRES_USER: wallet_user\n      POSTGRES_PASSWORD: ${DB_PASSWORD}\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./infrastructure/postgres/postgresql.conf:/etc/postgresql/postgresql.conf\n    restart: unless-stopped\n\n  redis:\n    image: redis:6-alpine\n    command: redis-server /usr/local/etc/redis/redis.conf\n    volumes:\n      - redis_data:/data\n      - ./infrastructure/redis/redis.conf:/usr/local/etc/redis/redis.conf\n    restart: unless-stopped\n\n  nginx:\n    image: nginx:alpine\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf\n      - ./infrastructure/ssl:/etc/ssl\n    depends_on:\n      - app\n    restart: unless-stopped\n\nvolumes:\n  postgres_data:\n  redis_data:\n```\n\n### Nginx Configuration\n\n```nginx\nserver {\n    listen 80;\n    server_name your-domain.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name your-domain.com;\n\n    ssl_certificate /etc/ssl/cert.pem;\n    ssl_certificate_key /etc/ssl/key.pem;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;\n    ssl_prefer_server_ciphers off;\n\n    location / {\n        proxy_pass http://app:3000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # WebSocket support\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n    }\n\n    location /health {\n        proxy_pass http://app:3000/health;\n        access_log off;\n    }\n\n    location /metrics {\n        proxy_pass http://app:3000/metrics;\n        allow 10.0.0.0/8;\n        deny all;\n    }\n}\n```\n\n## 📊 Monitoring Setup\n\n### Prometheus Configuration\n\n```yaml\n# prometheus.yml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nscrape_configs:\n  - job_name: 'wallet-api'\n    static_configs:\n      - targets: ['app:3000']\n    metrics_path: '/metrics'\n    scrape_interval: 30s\n\n  - job_name: 'postgres'\n    static_configs:\n      - targets: ['postgres-exporter:9187']\n\n  - job_name: 'redis'\n    static_configs:\n      - targets: ['redis-exporter:9121']\n\n  - job_name: 'nginx'\n    static_configs:\n      - targets: ['nginx-exporter:9113']\n```\n\n### Grafana Dashboard Setup\n\n```bash\n# Start monitoring stack\ndocker-compose -f infrastructure/monitoring/docker-compose.yml up -d\n\n# Import dashboards\ncurl -X POST \\\n  http://admin:admin@localhost:3001/api/dashboards/db \\\n  -H 'Content-Type: application/json' \\\n  -d @infrastructure/monitoring/grafana/dashboards/wallet-api.json\n```\n\n## 🔒 Security Hardening\n\n### 1. Firewall Configuration\n\n```bash\n# Configure UFW\nufw --force reset\nufw default deny incoming\nufw default allow outgoing\n\n# Allow necessary ports\nufw allow 22/tcp   # SSH\nufw allow 80/tcp   # HTTP\nufw allow 443/tcp  # HTTPS\n\n# Enable firewall\nufw --force enable\n```\n\n### 2. Database Security\n\n```bash\n# PostgreSQL security configuration\necho \"listen_addresses = 'localhost'\" >> /etc/postgresql/13/main/postgresql.conf\necho \"ssl = on\" >> /etc/postgresql/13/main/postgresql.conf\n\n# Restrict connections\necho \"host wallet_prod wallet_user 127.0.0.1/32 md5\" >> /etc/postgresql/13/main/pg_hba.conf\n```\n\n### 3. SSL/TLS Hardening\n\n```bash\n# Generate strong DH parameters\nopenssl dhparam -out /etc/ssl/dhparam.pem 2048\n\n# Add to nginx configuration\nssl_dhparam /etc/ssl/dhparam.pem;\nssl_session_timeout 1d;\nssl_session_cache shared:SSL:50m;\nssl_stapling on;\nssl_stapling_verify on;\n```\n\n## 💾 Backup and Recovery\n\n### Database Backup\n\n```bash\n#!/bin/bash\n# backup-database.sh\n\nBACKUP_DIR=\"/backups/postgres\"\nDATE=$(date +%Y%m%d_%H%M%S)\nDB_NAME=\"wallet_prod\"\n\n# Create backup\npg_dump -h localhost -U wallet_user $DB_NAME | \\\n  gzip > \"$BACKUP_DIR/wallet_db_$DATE.sql.gz\"\n\n# Encrypt backup\ngpg --encrypt --recipient backup@company.com \\\n  \"$BACKUP_DIR/wallet_db_$DATE.sql.gz\"\n\n# Clean old backups (keep 30 days)\nfind $BACKUP_DIR -name \"*.gpg\" -mtime +30 -delete\n```\n\n### Automated Backup Schedule\n\n```bash\n# Add to crontab\ncrontab -e\n\n# Daily backup at 2 AM\n0 2 * * * /opt/wallet/scripts/backup-database.sh\n\n# Weekly full system backup\n0 3 * * 0 /opt/wallet/scripts/backup-system.sh\n```\n\n### Recovery Process\n\n```bash\n# Restore from backup\ngpg --decrypt backup_file.sql.gz.gpg | \\\n  gunzip | \\\n  psql -h localhost -U wallet_user wallet_prod\n\n# Verify data integrity\npsql -h localhost -U wallet_user wallet_prod -c \"SELECT COUNT(*) FROM users;\"\n```\n\n## 🚀 Deployment Scripts\n\n### Production Deployment Script\n\n```bash\n#!/bin/bash\n# deploy-production.sh\n\nset -e\n\necho \"🚀 Starting production deployment...\"\n\n# Pull latest code\ngit pull origin main\n\n# Build application\necho \"📦 Building application...\"\nnpm ci --production\nnpm run build\n\n# Run database migrations\necho \"🗄️ Running database migrations...\"\nnpm run db:migrate:prod\n\n# Build and start containers\necho \"🐳 Starting Docker containers...\"\ndocker-compose -f infrastructure/docker-compose.prod.yml build\ndocker-compose -f infrastructure/docker-compose.prod.yml up -d\n\n# Wait for services to be ready\necho \"⏳ Waiting for services...\"\nsleep 30\n\n# Health check\necho \"🏥 Performing health check...\"\nif curl -f https://your-domain.com/health; then\n    echo \"✅ Deployment successful!\"\nelse\n    echo \"❌ Deployment failed!\"\n    exit 1\nfi\n\n# Clean up old images\ndocker image prune -f\n\necho \"🎉 Production deployment completed!\"\n```\n\n### Rollback Script\n\n```bash\n#!/bin/bash\n# rollback.sh\n\nset -e\n\nPREVIOUS_VERSION=${1:-HEAD~1}\n\necho \"🔄 Rolling back to $PREVIOUS_VERSION...\"\n\n# Checkout previous version\ngit checkout $PREVIOUS_VERSION\n\n# Rebuild and restart\nnpm ci --production\nnpm run build\n\ndocker-compose -f infrastructure/docker-compose.prod.yml build\ndocker-compose -f infrastructure/docker-compose.prod.yml up -d\n\n# Health check\nif curl -f https://your-domain.com/health; then\n    echo \"✅ Rollback successful!\"\nelse\n    echo \"❌ Rollback failed!\"\n    exit 1\nfi\n```\n\n## 📋 Deployment Checklist\n\n### Pre-Deployment\n- [ ] All tests passing\n- [ ] Security audit completed\n- [ ] Performance testing done\n- [ ] Backup procedures tested\n- [ ] SSL certificates valid\n- [ ] Environment variables configured\n- [ ] Database migrations ready\n- [ ] Smart contracts deployed\n- [ ] Monitoring configured\n\n### Deployment\n- [ ] Deploy backend services\n- [ ] Run database migrations\n- [ ] Verify smart contract deployment\n- [ ] Configure load balancer\n- [ ] Test all API endpoints\n- [ ] Verify SSL configuration\n- [ ] Check application logs\n- [ ] Validate monitoring alerts\n\n### Post-Deployment\n- [ ] Monitor system metrics\n- [ ] Verify backup procedures\n- [ ] Test disaster recovery\n- [ ] Update documentation\n- [ ] Notify stakeholders\n- [ ] Schedule security review\n\n## 🔧 Maintenance\n\n### Regular Maintenance Tasks\n\n```bash\n# Weekly maintenance script\n#!/bin/bash\n# weekly-maintenance.sh\n\n# Update system packages\nsudo apt update && sudo apt upgrade -y\n\n# Clean Docker resources\ndocker system prune -f\n\n# Rotate logs\nlogrotate /etc/logrotate.conf\n\n# Check disk space\ndf -h\n\n# Verify backups\n./scripts/verify-backups.sh\n\n# Security scan\n./scripts/security-scan.sh\n```\n\n### Performance Monitoring\n\n```bash\n# Monitor key metrics\necho \"📊 System Performance Report\"\necho \"=============================\"\necho \"CPU Usage: $(top -bn1 | grep \"Cpu(s)\" | awk '{print $2}' | cut -d'%' -f1)\"\necho \"Memory Usage: $(free | grep Mem | awk '{printf \"%.2f%%\", $3/$2 * 100.0}')\"\necho \"Disk Usage: $(df -h / | awk 'NR==2{printf \"%s\", $5}')\"\necho \"Active Connections: $(netstat -an | grep :3000 | wc -l)\"\n```\n\n## 🆘 Troubleshooting\n\n### Common Issues\n\n#### Service Won't Start\n```bash\n# Check logs\ndocker-compose logs app\n\n# Check port conflicts\nsudo netstat -tulpn | grep :3000\n\n# Restart services\ndocker-compose restart\n```\n\n#### Database Connection Issues\n```bash\n# Test database connection\npsql -h localhost -U wallet_user -d wallet_prod\n\n# Check PostgreSQL logs\ndocker-compose logs postgres\n\n# Restart database\ndocker-compose restart postgres\n```\n\n#### SSL Certificate Issues\n```bash\n# Check certificate validity\nopenssl x509 -in /etc/ssl/cert.pem -text -noout\n\n# Test SSL connection\nopenssl s_client -connect your-domain.com:443\n\n# Renew Let's Encrypt certificate\ncertbot renew\n```\n\n### Emergency Procedures\n\n#### System Recovery\n```bash\n# Emergency rollback\n./scripts/rollback.sh\n\n# Restore from backup\n./scripts/restore-backup.sh latest\n\n# Scale down to maintenance mode\ndocker-compose scale app=0\n```\n\n#### Contact Information\n- **DevOps Team**: devops@company.com\n- **Security Team**: security@company.com\n- **On-call Engineer**: +1-555-0123\n\n---\n\n*This deployment guide is maintained by the DevOps team and updated with each release. For questions or issues, please contact the development team.*\n"